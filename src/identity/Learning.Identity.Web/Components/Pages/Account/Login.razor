@page "/account/login"
@inject SignInManager<ApplicationUser> SignInManager;
@inject UserManager<ApplicationUser> UserManager;
@inject NavigationManager NavigationManager;
@layout AccessLayout

@using Learning.Identity.Web.Components.Layout
@using Learning.Identity.Web.Data.Entities
@using Learning.Identity.Web.Data.Models
@using Microsoft.AspNetCore.Identity
@using System.Web

<EditForm Model="@Model" OnValidSubmit=OnSignIn >
    <MudPaper>
        <MudTextField @bind-Value="@Model.UserName" Label="Username" HelperText="Enter username" Variant="Variant.Filled" For="()=> Model.UserName"/>
        <MudTextField @bind-Value="@Model.Password" Label="Password" HelperText="Enter password" Variant="Variant.Filled" />
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" ButtonType="ButtonType.Submit">Sign In</MudButton>
    </MudPaper>
</EditForm>
<MudLink Href="/account/new">Create Account</MudLink>
@code {
    public SignInModel? Model { get; set; }

    [SupplyParameterFromQuery]
    public string ReturnUrl { get; set; }

    protected override void OnInitialized()
    {
        Model ??= new();
    }

    public async Task OnSignIn()
    {
        Guid key = Guid.NewGuid();
        AuthenticationMiddleware.Logins[key] = new LoginInfo { UserName = Model.UserName, Password = Model.Password };

        NavigationManager.NavigateTo($"/login?Key={key}&ReturnUrl={HttpUtility.UrlEncode(ReturnUrl)}", true);
    }
}
